<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Products</title>
<style>
body {
font-family: Arial, sans-serif;
background-color: #f9f9f9;
padding: 30px;
}

h1 {
text-align: center;
}

#userDetails {
background: #fff;
padding: 15px;
border-radius: 8px;
margin-bottom: 20px;
box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

#products {
margin-top: 20px;
}

.product {
background: #fff;
border-radius: 8px;
padding: 15px;
margin-bottom: 10px;
box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

#adminControls {
margin-bottom: 20px;
text-align: center;
}

button {
background-color: #4CAF50;
color: white;
padding: 10px 15px;
border: none;
border-radius: 5px;
cursor: pointer;
margin: 5px;
}

button:hover {
background-color: #45a049;
}

#addProductForm {
display: none;
background: #fff;
padding: 15px;
border-radius: 8px;
box-shadow: 0 0 5px rgba(0,0,0,0.1);
margin-bottom: 20px;
}

input, textarea {
display: block;
width: 100%;
margin-bottom: 10px;
padding: 8px;
border: 1px solid #ccc;
border-radius: 5px;
}
</style>
</head>
<body>
<h1>Products Page</h1>
<div id="userDetails"></div>
<button id="logoutBtn">Logout</button>

<div id="adminControls" style="display:none;">
<button id="addProductBtn">Add Product</button>

<form id="addProductForm">
<h3 id = "formTitle">Add New Product</h3>
<input type="text" id="productName" placeholder="Product Name" required>
<input type="number" id="productPrice" placeholder="Price" required>
<textarea id="productDesc" placeholder="Description" required></textarea>
<input type="number" id="productQty" placeholder="Quantity" required>
<button type="submit">Submit</button>
      <button type="button" id="cancelBtn">Cancel</button>

</form>
</div>

<div id="products"></div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const token = sessionStorage.getItem("idToken");
if (!token) {
window.location.href = "index.html";
}

const name = sessionStorage.getItem("displayName");
const email = sessionStorage.getItem("email");
const role = sessionStorage.getItem("role");

document.getElementById("userDetails").innerHTML = `
     <p><strong>Name:</strong> ${name}</p>
     <p><strong>Email:</strong> ${email}</p>
     <p><strong>Role:</strong> ${role}</p>
   `;

// Show admin section if user is admin
if (role === "admin") {
document.getElementById("adminControls").style.display = "block";
}

document.getElementById("logoutBtn").addEventListener("click", () => {
sessionStorage.clear();
window.location.href = "index.html";
});

async function fetchProducts() {
try {
const res = await axios.get(
"https://firestore.googleapis.com/v1/projects/flipzon-69df3/databases/(default)/documents/Products",
{ headers: { Authorization: `Bearer ${token}` } }
);

const productsDiv = document.getElementById("products");
const docs = res.data.documents || [];

if (docs.length === 0) {
productsDiv.innerHTML = "<p>No products found.</p>";
return;
}

productsDiv.innerHTML = ""; // Clear first

docs.forEach(doc => {
const id = doc.name.split("/").pop(); // get document ID
const fields = doc.fields;

const div = document.createElement("div");
div.className = "product";
div.innerHTML = `
       <h3>${fields.name?.stringValue || "Unnamed"}</h3>
       <p><strong>Price:</strong> â‚¹${fields.price?.integerValue || "0"}</p>
       <p><strong>Description:</strong> ${fields.description?.stringValue || "No details"}</p>
       <p><strong>Quantity:</strong> ${fields.quantity?.integerValue || "0"}</p>
     `;

if (role === "admin") {
// Edit button
const editBtn = document.createElement("button");
editBtn.textContent = "âœï¸ Edit";
editBtn.addEventListener("click", () => showEditProductForm(id, fields));
div.appendChild(editBtn);

// Delete button
const deleteBtn = document.createElement("button");
deleteBtn.textContent = "ðŸ—‘ï¸ Delete";
deleteBtn.addEventListener("click", () => deleteProduct(id));
div.appendChild(deleteBtn);
}

productsDiv.appendChild(div);
});

} catch (err) {
console.error(err);
document.getElementById("products").innerText = "Failed to load products.";
}
}

// Show Edit Form prefilled
function showEditProductForm(id, fields) {
  const form = document.getElementById("addProductForm");
  const formTitle = document.getElementById("formTitle");
  formTitle.textContent = "Edit Product";
  form.style.display = "block";

  document.getElementById("productName").value = fields.name?.stringValue || "";
  document.getElementById("productPrice").value = fields.price?.integerValue || "";
  document.getElementById("productDesc").value = fields.description?.stringValue || "";
  document.getElementById("productQty").value = fields.quantity?.integerValue || "";

  // Remove any old listeners
  const newForm = form.cloneNode(true);
  form.parentNode.replaceChild(newForm, form);

  newForm.querySelector("#cancelBtn").addEventListener("click", () => {
    newForm.reset();
    newForm.style.display = "none";
    formTitle.textContent = "Add New Product";
  });

  newForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      await axios.patch(
        `https://firestore.googleapis.com/v1/projects/flipzon-69df3/databases/(default)/documents/Products/${id}`,
        {
          fields: {
            name: { stringValue: document.getElementById("productName").value },
            price: { integerValue: parseInt(document.getElementById("productPrice").value) },
            description: { stringValue: document.getElementById("productDesc").value },
            quantity: { integerValue: parseInt(document.getElementById("productQty").value) },
          },
        },
        { headers: { Authorization: `Bearer ${token}` } }
      );

      alert("âœ… Product updated successfully!");
      newForm.reset();
      newForm.style.display = "none";
      formTitle.textContent = "Add New Product";
      fetchProducts();
    } catch (err) {
      console.error("Edit Product Error:", err.response?.data || err);
      alert("Failed to update product.");
    }
  });
}


// Delete Product
async function deleteProduct(id) {
if (!confirm("Are you sure you want to delete this product?")) return;
try {
await axios.delete(
`https://firestore.googleapis.com/v1/projects/flipzon-69df3/databases/(default)/documents/Products/${id}`,
{ headers: { Authorization: `Bearer ${token}` } }
);
alert("Product deleted successfully!");
fetchProducts();
} catch (err) {
console.error("Delete Product Error:", err.response?.data || err);
alert("Failed to delete product.");
}
}


fetchProducts();

// ADMIN â€” Add Product
const addProductBtn = document.getElementById("addProductBtn");
const addProductForm = document.getElementById("addProductForm");

    addProductBtn.addEventListener("click", () => {
  formTitle.textContent = "Add New Product";
  addProductForm.reset();
  addProductForm.style.display = "block";
  addProductForm.onsubmit = null; 
});

addProductForm.addEventListener("submit", async (e) => {
e.preventDefault();

const name = document.getElementById("productName").value.trim();
const price = parseInt(document.getElementById("productPrice").value);
const description = document.getElementById("productDesc").value.trim();
const quantity = parseInt(document.getElementById("productQty").value);

if (!name || !price || !description || !quantity) {
alert("Please fill all fields.");
return;
}

try {
await axios.post(
"https://firestore.googleapis.com/v1/projects/flipzon-69df3/databases/(default)/documents/Products",
{
fields: {
name: { stringValue: name },
price: { integerValue: price },
description: { stringValue: description },
quantity: { integerValue: quantity },
}
},
{ headers: { Authorization: `Bearer ${token}` } }
);

alert("Product added successfully!");
addProductForm.reset();
addProductForm.style.display = "none";
fetchProducts(); // refresh list

} catch (err) {
console.error("Add Product Error:", err.response?.data || err);
alert("Failed to add product. Check console for details.");
}
});

async function editProduct(id) {
editingId = id;
document.getElementById("formTitle").textContent = "Edit Product";
document.getElementById("productForm").style.display = "block";

try {
const res = await axios.get(`https://firestore.googleapis.com/v1/projects/flipzon-69df3/databases/(default)/documents/Products/${id}`);
const p = res.data.fields;
document.getElementById("name").value = p.name.stringValue;
document.getElementById("price").value = p.price.integerValue;
document.getElementById("desc").value = p.desc.stringValue;
document.getElementById("qty").value = p.qty.integerValue;
} catch (err) {
console.error("Error loading product:", err);
}
}
// Cancel button - hides the form and resets inputs
document.getElementById("cancelBtn").addEventListener("click", () => {
  const form = document.getElementById("addProductForm");
  form.reset();
  form.style.display = "none";
  document.getElementById("formTitle").textContent = "Add New Product";
});


</script>
</body>
</html>